"use strict";function disableCaptcha(){$("#CaptchaInputText").attr("disabled","disabled");$(".captcha-button").attr("disabled","disabled")}function expireCaptcha(){$("#CaptchaInputText").val("");var n={userSessionKey:userSessionKey,areaName:areaName},t=$.ajax({url:serverUrl+"/Otp/ExpireCaptcha",method:"POST",data:n,type:"json"});t.done(function(){return})}function refreshCaptcha(){var n=serverUrl+"/"+areaName,t="data:image/JPEG;base64,",i=$("#CaptchaImage"),r=$("#CaptchaInputText"),u=$("#CaptchaRefreshButton"),f=$.ajax({url:n,data:{sessionKey:userSessionKey,action:"GetCaptcha"},method:"POST"});f.done(function(n){i.attr("src",t+n.image);r.val("").removeAttr("disabled");u.removeAttr("disabled")})}function hasUserSelectedGiftCard(){return $("#CardSelector li a.dropdown-selected").attr("data-giftCard")==="True"}function showCardMessage(n){var t=$("#afterCardNotice");t.is(":visible")||(t.find(".message").text(n),t.slideDown("slow"))}function hideCardMessage(){var n=$("#afterCardNotice");n.is("hidden")||(n.find(".message").text(""),n.slideUp("slow"))}function K1CustomeOtpTimer(n,t){this._duration=n;this._elemID=t;this._timerID=null}function CurrentPan(){this._pan=""}function showOtpResponseModal(n,t){var i=$("#otpResponseModal"),r=$("#closeMessageButton");i.find("#otpResponseParagraph").html(n);i.css("background-color","rgba(51,51,51,0.5)");i.fadeIn("slow");t!=null&&t!=undefined&&Number(t)>0?(r.hide(),setTimeout(function(){i.fadeOut("slow")},t)):r.show();i.find(".btn-close,#otpResponseModal.close").click(function(){$("#otpResponseModal").fadeOut("slow")})}function showOtpMessageModal(){var n=$("#otpMessageModal");n.css("background-color","rgba(51,51,51,0.5)");n.fadeIn("slow");n.find(".modal-body p").css("text-align","justify");n.find(".close,.btn-close").click(function(){n.fadeOut("slow");setTimeout(function(){n.remove()},355)})}function PansTimersHistory(){this._dic={}}function TimerHistory(n,t){this._stopedAt=n;this._elapsedTime=t}function OtpRequestModel(n,t,i,r,u,f){this.pan=n;this.sessionKey=t;this.areaName=i;this.subCardId=r;this.CaptchaDeText=u;this.CaptchaInputText=f}function getPan(n){var t,i;if(n!=null)return $("#CardNumber_Pan"+n).val();for(t="",i=0;i<4;i++)t+=$("#CardNumber_Pan"+i).val();return $("#CardNumber_Pan4").val()&&(t+=$("#CardNumber_Pan4").val()),t}function getSelectedCardId(){var n=$("#SelectedCardId").val(),t=!(n===undefined||n===null||isEmptyOrSpaces(n));return t?n:null}function handleFailedOtp(){OtpRequestButton.Disable();_otpTimer.Stop();$("#frmFailedOtp").submit()}function handleTryAgain(){if(otpSettings.maxTriesCount<=0){handleFailedOtp();return}OtpRequestButton.ToTryAgainState();refreshCaptcha();enableCvv2();enableExpireDate();enableChangeExpireDate();enablePanTextBoxes()}function timerCallBack(){handleTryAgain();enableCvv2();enableExpireDate();enableCardSelector();enableChangeExpireDate();enablePanTextBoxes();_history.Remove(_currentPan.Get());isEmptyOrSpaces(otpSettings.otpTryAgainMessage)==!1&&showOtpResponseModal(otpSettings.otpTryAgainMessage)}function disablePanTextBoxes(){$("#CardNumber_Pan0").attr("readonly","readonly");$("#CardNumber_Pan1").attr("readonly","readonly");$("#CardNumber_Pan2").attr("readonly","readonly");$("#CardNumber_Pan3").attr("readonly","readonly")}function enablePanTextBoxes(){$("#CardNumber_Pan0").removeAttr("readonly");$("#CardNumber_Pan1").removeAttr("readonly");$("#CardNumber_Pan2").removeAttr("readonly");$("#CardNumber_Pan3").removeAttr("readonly")}function disableChangeExpireDate(){$("#btnChangeExpDate").attr("disabled","disabled")}function enableChangeExpireDate(){$("#btnChangeExpDate").removeAttr("disabled")}function disableCvv2(){$("#Cvv2").attr("readonly","readonly")}function enableCvv2(){$("#Cvv2").removeAttr("readonly")}function disableExpireDate(){$("#Month").attr("readonly","readonly");$("#Year").attr("readonly","readonly")}function enableExpireDate(){$("#Month").removeAttr("readonly");$("#Year").removeAttr("readonly")}function disableCardSelector(){$("#CardNumberCover").hide();$("#CardSelector_Container").addClass("hidden")}function enableCardSelector(){$("#CardNumberCover").show();$("#CardSelector_Container").removeClass("hidden")}function sendOtpRequest(n,t){var i=$.ajax({url:serverUrl+"/Otp/RequestOtp",method:"POST",data:n,type:"json"});i.done(function(i){var r,u;if(i!==undefined&&i!==null)if(r=i,r.HasError===!1)otpSettings.maxTriesCount--,showOtpResponseModal(r.Message,autoHideMessageTimeOut),OtpRequestButton.ToTimerState(),disableCaptcha(),disableCvv2(),disableExpireDate(),disableCardSelector(),disableChangeExpireDate(),disablePanTextBoxes(),u=t?n.subCardId:n.pan,_currentPan.Set(u),_otpTimer.Start(timerCallBack);else if(refreshCaptcha(),OtpRequestButton.Enable(),showOtpResponseModal(i.Message),enableCvv2(),enableExpireDate(),enableCardSelector(),enableChangeExpireDate(),enablePanTextBoxes(),otpSettings.maxTriesCount<=0){timerToFailedOtp();return}});i.fail(function(){showOtpResponseModal("خطا در برقرای ارتباط با سرور");OtpRequestButton.Enable()})}function handleChangePan(n,t){var r,i;try{_currentPan.Set(n);var u=new Date,f=_otpTimer.Stop(),e=new TimerHistory(u,f);if(_history.Save(t,e),r=_history.Get(n),r==null){OtpRequestButton.ToTryAgainState();return}if(i=r.GetRealElapsedSeconds(),i==null||i<=0){_history.Remove(n);OtpRequestButton.ToTryAgainState();return}OtpRequestButton.ToTimerState();_otpTimer.Start(timerCallBack,i)}finally{refreshCaptcha()}}var giftCardRange,OtpButtonStates,OtpRequestButton;$(function(){refreshCaptcha();$("#CaptchaRefreshButton").click(refreshCaptcha)});giftCardRange={min:20,max:49,isInRange:function(n){if(n===undefined||n===null||n===""||n.length!=4)return!1;var t=Number(n.substring(2,4));return t>=this.min&&t<=this.max}};$(function(){$("#CardNumber_Pan1").keyup(function(){var n=$(this).val();n.length===4&&(giftCardRange.isInRange(n)?showCardMessage(giftCardHintMessage):hideCardMessage())});$("#SelectedCardId").on("cardChanged",function(){var n=hasUserSelectedGiftCard();n?showCardMessage(giftCardHintMessage):hideCardMessage()})});K1CustomeOtpTimer.prototype.Start=function(n,t){var i,r,f=document.getElementById(this._elemID),u=t==null?this._duration:t,e=setInterval(function(){i=parseInt(u/60,10);r=parseInt(u%60,10);i=i<10?"0"+i:i;r=r<10?"0"+r:r;f.textContent=i+":"+r;f.value=u;--u<0&&(f.elapsed=0,clearInterval(e),n())},1e3);this._timerID=e};K1CustomeOtpTimer.prototype.Stop=function(){var n=document.getElementById(this._elemID).value;return clearInterval(this._timerID),n};CurrentPan.prototype.Set=function(n){this._pan=n};CurrentPan.prototype.Get=function(){return this._pan};PansTimersHistory.prototype.Save=function(n,t){this._dic[n]=t};PansTimersHistory.prototype.Get=function(n){var t=this._dic[n];return t==null?null:t};PansTimersHistory.prototype.Remove=function(n){this._dic[n]=null};TimerHistory.prototype.GetStopedAtTotalSeconds=function(){return this._stopedAt===null||this._stopedAt===undefined?0:parseInt(this._stopedAt.getTime()/1e3)};TimerHistory.prototype.GetRealElapsedSeconds=function(){var t=this.GetStopedAtTotalSeconds(),i=parseInt((new Date).getTime()/1e3),r=this._elapsedTime,u=i-t,n=r-u;return n>=0?n:0};OtpButtonStates={Normal:"1",Timer:"2",TryAgain:"3"};OtpRequestButton={ElementID:"requestOtpButton",Enable:function(){$("#frmPayment").find("#requestOtpButton").removeAttr("disabled")},Disable:function(){$("#frmPayment").find("#requestOtpButton").attr("disabled","disabled")},ToTimerState:function(){var n=$("#frmPayment").find("#requestOtpButton");n.attr("data-state")!=OtpButtonStates.Timer&&n.attr("data-state",OtpButtonStates.Timer).text("").attr("disabled","disabled").addClass("btn-timer")},ToTryAgainState:function(){var n=$("#frmPayment").find("#requestOtpButton");n.attr("data-state")!=OtpButtonStates.TryAgain&&n.attr("data-state",OtpButtonStates.TryAgain).removeAttr("disabled").removeClass("btn-timer").text("دریافت مجدد رمز پویا")}};"use strict";var _otpTimer=new K1CustomeOtpTimer(otpSettings.otpTimeOut,OtpRequestButton.ElementID),_currentPan=new CurrentPan,_history=new PansTimersHistory;$(function(){$("#otpMessageModal").length&&showOtpMessageModal();$("#requestOtpButton").click(function(n){var r,t;if(n.preventDefault(),otpSettings.maxTriesCount<=0){OtpRequestButton.Disable();return}$("#frmPayment").validate().settings.ignore=":hidden, #Pin2";try{if(!$("#frmPayment").valid())return}finally{$("#frmPayment").validate().settings.ignore=":hidden"}if(r=$("input[name='CaptchaInputText']").val(),isEmptyOrSpaces(r)){showOtpResponseModal("لطفاً کد امنیتی داخل تصویر را وارد کنید");return}var i=getPan(),e=$("#CaptchaDeText").val(),f=getSelectedCardId(),u=f!=null;if(u&&(i=""),isEmptyOrSpaces(i)){if(u===!1){showOtpResponseModal("شماره کارت الزامی میباشد.");return}}else if(isValidCard(i)==!1){showOtpResponseModal("شماره کارت را به درستی وارد کنید.");return}OtpRequestButton.Disable();t=new OtpRequestModel;t.pan=i;t.sessionKey=userSessionKey;t.areaName=areaName;t.subCardId=f;t.CaptchaDeText=e;t.CaptchaInputText=r;sendOtpRequest(t,u)});$("#frmPayment").submit(function(n){n.preventDefault();$("#button-payment-pay").attr("disabled","disabled");_otpTimer.Stop();$(this).unbind("submit");setTimeout(function(){$("#frmPayment").submit()},100)});$("#CardNumber_Pan0, #CardNumber_Pan1, #CardNumber_Pan2, #CardNumber_Pan3").keyup(function(){var t=getPan(),n;t!=null&&t.length===16&&(n=_currentPan.Get(),n!=null&&n!=""&&t!==n&&handleChangePan(t,n))});$("#SelectedCardId").on("cardChanged",function(){var t=getSelectedCardId(),n;t!=null&&t>0&&(n=_currentPan.Get(),n!=null&&n!=""&&t!==n&&handleChangePan(t,n))})})